# Nome do workflow
name: Fix All Project Files (Packages and Imports)

# Gatilho: Apenas manual (workflow_dispatch)
on:
  workflow_dispatch:

jobs:
  fix-and-commit:
    runs-on: ubuntu-latest

    # Permissões para que o workflow possa fazer commit
    permissions:
      contents: write

    steps:
      # 1. Baixa o código do repositório
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Roda o script principal de correção
      - name: Run Refactor Script
        run: |
          # --- PARTE 1: CORRIGIR O CÓDIGO DO EMULADOR (PASTA /core) ---
          echo "### STARTING CORE REFACTOR ###"
          CORE_SRC_DIR="app/src/main/kotlin/com/zash60/kotnes/core"
          BASE_KOTLIN_DIR="app/src/main/kotlin"
          BASE_PACKAGE="com.zash60.kotnes.core"
          
          # Lista de todos os seus sub-pacotes
          SUB_PACKAGES=("apu" "cartridge" "cpu" "dma" "exception" "ext" "interrupts" "pad" "ppu" "ram" "util")

          # Itera em todos os arquivos .kt dentro da pasta /core
          find "$CORE_SRC_DIR" -name "*.kt" | while read file; do
            echo "Processing Core File: $file"

            # Corrige a declaração 'package'
            dir=$(dirname "$file")
            package_path=${dir#"$BASE_KOTLIN_DIR/"}
            correct_package=$(echo "$package_path" | sed 's|/|.|g')
            sed -i "s|^package.*|package $correct_package|" "$file"

            # Corrige as declarações 'import'
            for sub_package in "${SUB_PACKAGES[@]}"; do
              sed -i "s|import $sub_package.|import $BASE_PACKAGE.$sub_package.|g" "$file"
            done
          done
          echo "### FINISHED CORE REFACTOR ###"

          # --- PARTE 2: CORRIGIR OS ARQUIVOS DA UI (MainActivity, ViewModel) ---
          echo "### STARTING UI REFACTOR ###"
          MAIN_ACTIVITY="app/src/main/kotlin/com/zash60/kotnes/MainActivity.kt"
          VIEW_MODEL="app/src/main/kotlin/com/zash60/kotnes/EmulatorViewModel.kt"
          UI_PACKAGE="com.zash60.kotnes.ui"

          # Adiciona o import que falta na MainActivity
          if ! grep -q "import $UI_PACKAGE" "$MAIN_ACTIVITY"; then
            sed -i "/package com.zash60.kotnes/a import $UI_PACKAGE.EmulatorView" "$MAIN_ACTIVITY"
            echo "Fixed import in MainActivity.kt"
          fi
          
          # Adiciona o import que falta no EmulatorViewModel
          if ! grep -q "import $UI_PACKAGE" "$VIEW_MODEL"; then
            sed -i "/package com.zash60.kotnes/a import $UI_PACKAGE.*" "$VIEW_MODEL"
            echo "Fixed import in EmulatorViewModel.kt"
          fi
          echo "### FINISHED UI REFACTOR ###"
          
          # --- PARTE 3: CORRIGIR ARQUIVO CPU.KT (CASO ESPECIAL) ---
          # O log mostrou que a primeira linha do Cpu.kt estava corrompida.
          # Este comando garante que a linha 'package' esteja correta.
          echo "### VERIFYING CPU.KT ###"
          CPU_FILE="app/src/main/kotlin/com/zash60/kotnes/core/cpu/Cpu.kt"
          sed -i '1s|.*|package com.zash60.kotnes.core.cpu|' "$CPU_FILE"
          echo "Ensured correct package in Cpu.kt"

      # 3. Faz o commit de todas as alterações
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Adiciona TODAS as mudanças no repositório
          git add .
          
          # Verifica se há algo para commitar
          if ! git diff-index --quiet HEAD; then
            git commit -m "fix(project): Refactor all packages and imports for Android"
            git push
          else
            echo "No changes were needed."
          fi
