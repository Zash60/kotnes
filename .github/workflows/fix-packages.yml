# Nome do workflow
name: Fix All Missing Imports

# Gatilho: Apenas manual (workflow_dispatch)
on:
  workflow_dispatch:

jobs:
  fix-and-commit:
    runs-on: ubuntu-latest

    # Permissões para que o workflow possa fazer commit
    permissions:
      contents: write

    steps:
      # 1. Baixa o código do repositório
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Roda o script principal de correção de imports
      - name: Run Import Refactor Script
        run: |
          echo "### STARTING FINAL IMPORT FIX ###"
          CORE_SRC_DIR="app/src/main/kotlin/com/zash60/kotnes/core"
          
          # Itera em todos os arquivos .kt dentro da pasta /core
          find "$CORE_SRC_DIR" -name "*.kt" | while read file; do
            echo "Processing File: $file"
            
            # Garante que a declaração do pacote está correta
            dir=$(dirname "$file")
            package_path=${dir#"app/src/main/kotlin/"}
            correct_package=$(echo "$package_path" | sed 's|/|.|g')
            sed -i "1s|^.*|package $correct_package|" "$file"

            # Lista de imports a serem garantidos
            IMPORTS_TO_ADD=(
              "com.zash60.kotnes.core.ext.toInt"
              "com.zash60.kotnes.core.ext.toUnsignedInt"
              "com.zash60.kotnes.core.ext.extract"
              "com.zash60.kotnes.core.ext.isSetUByte"
              "com.zash60.kotnes.core.ext.isSetUInt"
              "com.zash60.kotnes.core.ext.update"
              "com.zash60.kotnes.core.cpu.Cpu"
              "com.zash60.kotnes.core.apu.Apu"
            )

            # Adiciona os imports que faltam logo após a linha do pacote
            for import_line in "${IMPORTS_TO_ADD[@]}"; do
              # Verifica se o import já não existe no arquivo
              if ! grep -q "import $import_line" "$file"; then
                # Adiciona o import se o arquivo usa alguma palavra-chave relacionada
                # (Isso evita adicionar imports desnecessários em todos os arquivos)
                # Usamos um curinga simples para verificar o uso.
                if grep -q -E "(toInt|toUnsignedInt|extract|isSetUByte|isSetUInt|update|Cpu|Apu)" "$file"; then
                  sed -i "/^package /a import $import_line" "$file"
                  echo "  - Added import: $import_line"
                fi
              fi
            done
          done
          
          # Remove imports duplicados que possam ter sido adicionados
          find "$CORE_SRC_DIR" -name "*.kt" -exec sh -c 'awk "!seen[\$0]++" "$0" > "$0.tmp" && mv "$0.tmp" "$0"' {} \;

          echo "### FINISHED FINAL IMPORT FIX ###"

      # 3. Faz o commit de todas as alterações
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Adiciona TODAS as mudanças no repositório
          git add .
          
          # Verifica se há algo para commitar
          if ! git diff-index --quiet HEAD; then
            git commit -m "fix(core): Add all missing ext imports and correct packages"
            git push
          else
            echo "No changes were needed."
          fi
