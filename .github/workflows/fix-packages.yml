# Nome do workflow
name: Fix Everything (Packages, Imports, Syntax)

# Gatilho: Apenas manual (workflow_dispatch)
on:
  workflow_dispatch:

jobs:
  fix-and-commit:
    runs-on: ubuntu-latest

    # Permissões para que o workflow possa fazer commit
    permissions:
      contents: write

    steps:
      # 1. Baixa o código do repositório
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Roda o script principal de correção
      - name: Run Final Refactor Script
        run: |
          echo "### STARTING FINAL REFACTOR SCRIPT ###"
          CORE_SRC_DIR="app/src/main/kotlin/com/zash60/kotnes/core"
          
          # Itera em todos os arquivos .kt dentro da pasta /core
          find "$CORE_SRC_DIR" -name "*.kt" | while read file; do
            echo "--- Processing File: $file ---"

            # --- Passo A: Limpeza dos imports antigos ---
            # Remove todas as linhas que começam com "import", limpando a bagunça
            sed -i '/^import /d' "$file"
            echo "  - Cleared old imports."

            # --- Passo B: Correção da declaração 'package' ---
            dir=$(dirname "$file")
            package_path=${dir#"app/src/main/kotlin/"}
            correct_package=$(echo "$package_path" | sed 's|/|.|g')
            sed -i "1s|^.*|package $correct_package|" "$file"
            echo "  - Set package to: $correct_package"

            # --- Passo C: Adiciona um bloco de imports limpo ---
            # Este bloco contém todos os imports que podem ser necessários
            IMPORT_BLOCK="
            import com.zash60.kotnes.core.apu.*
            import com.zash60.kotnes.core.cartridge.*
            import com.zash60.kotnes.core.cpu.*
            import com.zash60.kotnes.core.dma.*
            import com.zash60.kotnes.core.exception.*
            import com.zash60.kotnes.core.ext.*
            import com.zash60.kotnes.core.interrupts.*
            import com.zash60.kotnes.core.pad.*
            import com.zash60.kotnes.core.ppu.*
            import com.zash60.kotnes.core.ram.*
            import com.zash60.kotnes.core.util.*
            import java.io.File
            import java.math.BigInteger
            import kotlin.math.pow
            import kotlin.math.round
            "
            # Adiciona o bloco de imports logo após a linha do pacote
            sed -i "/^package /r /dev/stdin" "$file" <<< "$IMPORT_BLOCK"
            echo "  - Added clean import block."

          done
          
          # --- Passo D: Substitui Emulator.kt completamente ---
          echo "### REPLACING Emulator.kt ###"
          EMULATOR_FILE="$CORE_SRC_DIR/Emulator.kt"
          cat > "$EMULATOR_FILE" << 'EOF'
          package com.zash60.kotnes.core

          import com.zash60.kotnes.core.apu.*
          import com.zash60.kotnes.core.cartridge.Cartridge
          import com.zash60.kotnes.core.cartridge.Rom
          import com.zash60.kotnes.core.cpu.Cpu
          import com.zash60.kotnes.core.cpu.CpuBus
          import com.zash60.kotnes.core.dma.Dma
          import com.zash60.kotnes.core.ext.toUnsignedInt
          import com.zash60.kotnes.core.interrupts.Interrupts
          import com.zash60.kotnes.core.pad.KeyEvent
          import com.zash60.kotnes.core.pad.Pad
          import com.zash60.kotnes.core.ppu.Canvas
          import com.zash60.kotnes.core.ppu.Ppu
          import com.zash60.kotnes.core.ram.Ram
          import kotlin.math.round

          class Emulator(
              cartridge: Cartridge,
              canvas: Canvas,
              keyEvent: KeyEvent,
          ) {
              private val interrupts = Interrupts()
              private val chrRam = Ram(0x4000).apply {
                  cartridge.character.forEachIndexed { idx, data ->
                      write(idx, data.toUnsignedInt())
                  }
              }

              private val ppu = Ppu(
                  chrRam = chrRam,
                  canvas = canvas,
                  interrupts = interrupts,
                  isHorizontalMirror = cartridge.isHorizontalMirror
              )

              private val apu = Apu(
                  pulse1 = PulseChannel(
                      envelopeGenerator = EnvelopeGenerator(),
                      lengthCounter = LengthCounter(),
                      isChannelOne = true,
                  ),
                  pulse2 = PulseChannel(
                      envelopeGenerator = EnvelopeGenerator(),
                      lengthCounter = LengthCounter(),
                      isChannelOne = false,
                  ),
                  triangle = TriangleChannel(
                      lengthCounter = LengthCounter(),
                  ),
                  noise = NoiseChannel(
                      envelopeGenerator = EnvelopeGenerator(),
                      lengthCounter = LengthCounter(),
                  )
              )
              private val wRam = Ram(0x2048)
              private val prgRom = Rom(cartridge.program)
              private val dma = Dma(ppu, wRam)
              private val pad = Pad(keyEvent)

              private val cpuBus = CpuBus(
                  ppu = ppu,
                  apu = apu,
                  ram = wRam,
                  rom = prgRom,
                  dma = dma,
                  pad = pad
              )

              private val cpu = Cpu(
                  bus = cpuBus,
                  interrupts = interrupts
              )

              private var sleepMargin = 0L

              fun start() {
                  while (true) {
                      val frameStartNs = System.nanoTime()
                      stepFrame()
                      val frameEndNs = System.nanoTime()

                      val sleepTimeNs = (FRAME_NS - (frameEndNs - frameStartNs)) + sleepMargin
                      val sleepTimeMs = sleepTimeNs / 1000_000
                      val sleepStartNs = System.nanoTime()
                      if (sleepTimeMs > 0) {
                          Thread.sleep(sleepTimeMs)
                      }
                      val sleepEnd = System.nanoTime()
                      sleepMargin = sleepTimeNs - (sleepEnd - sleepStartNs)
                  }
              }

              private fun stepFrame() {
                  while (true) {
                      var cpuCycle = 0
                      if (dma.isProcessing) {
                          dma.run()
                          cpuCycle = 514
                      }
                      cpuCycle += cpu.run()
                      apu.run(cpuCycle)
                      if (ppu.run(cpuCycle * 3)) {
                          break
                      }
                  }
              }

              companion object {
                  private val FRAME_NS = round(1.0 / 60 * 1000_000_000).toInt() // 60fps
              }
          }
          EOF
          echo "Emulator.kt replaced with a clean version."

          echo "### SCRIPT FINISHED ###"

      # 3. Faz o commit de todas as alterações
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          
          if ! git diff-index --quiet HEAD; then
            git commit -m "chore(build): Final fix for all packages, imports, and syntax"
            git push
          else
            echo "No changes were needed."
          fi
